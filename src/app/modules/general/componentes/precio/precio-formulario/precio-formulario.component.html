<form [formGroup]="formularioPrecio" (ngSubmit)="enviarFormulario()">
  <div class="d-flex mb-2">
    <app-comun-btn-atras />
    <button
      type="submit"
      class="btn btn-primary btn-sm"
      #btnGuardar
      translate="FORMULARIOS.BOTONES.COMUNES.GUARDAR"
    ></button>
  </div>
  <app-card>
    <section card-titulo>
      <ng-container *ngIf="accion === 'nuevo'; else tituloDetalle">
        {{ "MENU.FUNCIONALIDAD." + (modelo | uppercase) | translate }}
        {{ "FORMULARIOS.BOTONES.COMUNES.NUEVO" | translate }}
      </ng-container>
      <ng-template #tituloDetalle>
        {{ "FORMULARIOS.BOTONES.COMUNES.EDITAR" | translate }}
        {{ modelo }}
        {{ detalle }}
      </ng-template>
    </section>
    <section card-body>
      <div class="row mb-5">
        <div class="col-md-6 col-sm-12">
          <label
            translate="FORMULARIOS.CAMPOS.COMUNES.NOMBRE"
            class="form-label required"
          ></label>
          <input
            formControlName="nombre"
            class="form-control bg-transparent"
            type="email"
            autocomplete="off"
            [ngClass]="{
              'is-invalid':
                formularioPrecio.controls['nombre'].touched &&
                formularioPrecio.controls['nombre'].invalid,
              'is-valid':
                formularioPrecio.controls['nombre'].touched &&
                formularioPrecio.controls['nombre'].valid
            }"
          />
          <ng-container
            [ngTemplateOutlet]="formError"
            [ngTemplateOutletContext]="{
              validation: 'required',
              message: 'FORMULARIOS.VALIDACIONES.COMUNES.REQUERIDO' | translate,
              control: formularioPrecio.controls['nombre']
            }"
          ></ng-container>
          <ng-container
            [ngTemplateOutlet]="formError"
            [ngTemplateOutletContext]="{
              validation: 'maxlength',
              message:
                'FORMULARIOS.VALIDACIONES.COMUNES.CAMPOMAXIMO' | translate,
              cantidadCaracteres: '100',
              control: formularioPrecio.controls['nombre']
            }"
          ></ng-container>
        </div>
      </div>
      <div class="row mb-5">
        <div class="col-md-6 col-sm-12">
          <label
            translate="FORMULARIOS.CAMPOS.GENERAL.PRECIO.TIPO"
            class="form-label required"
          ></label>
          <input
            formControlName="tipo"
            class="form-control bg-transparent"
            type="email"
            autocomplete="off"
            [ngClass]="{
              'is-invalid':
                formularioPrecio.controls['tipo'].touched &&
                formularioPrecio.controls['tipo'].invalid,
              'is-valid':
                formularioPrecio.controls['tipo'].touched &&
                formularioPrecio.controls['tipo'].valid
            }"
          />
          <ng-container
            [ngTemplateOutlet]="formError"
            [ngTemplateOutletContext]="{
              validation: 'required',
              message: 'FORMULARIOS.VALIDACIONES.COMUNES.REQUERIDO' | translate,
              control: formularioPrecio.controls['tipo']
            }"
          ></ng-container>
          <ng-container
            [ngTemplateOutlet]="formError"
            [ngTemplateOutletContext]="{
              validation: 'maxlength',
              message:
                'FORMULARIOS.VALIDACIONES.COMUNES.CAMPOMAXIMO' | translate,
              cantidadCaracteres: '100',
              control: formularioPrecio.controls['tipo']
            }"
          ></ng-container>
          <ng-container
            [ngTemplateOutlet]="formError"
            [ngTemplateOutletContext]="{
              validation: 'pattern',
              message: 'FORMULARIOS.VALIDACIONES.COMUNES.NOVALIDO' | translate,
              control: formularioPrecio.controls['tipo']
            }"
          ></ng-container>
        </div>
        <div class="col-md-6 col-sm-12">
          <label
            translate="FORMULARIOS.CAMPOS.GENERAL.PRECIO.FECHAVENCE"
            class="form-label required"
          ></label>
          <input
            #fechaDesde
            formControlName="fecha_vence"
            class="form-control bg-transparent"
            type="date"
            autocomplete="off"
            [ngClass]="{
              'is-invalid':
                formularioPrecio.controls['fecha_vence'].touched &&
                formularioPrecio.controls['fecha_vence'].invalid,
              'is-valid':
                formularioPrecio.controls['fecha_vence'].touched &&
                formularioPrecio.controls['fecha_vence'].valid
            }"
          />
          <ng-container
            [ngTemplateOutlet]="formError"
            [ngTemplateOutletContext]="{
              validation: 'required',
              message: 'FORMULARIOS.VALIDACIONES.COMUNES.REQUERIDO' | translate,
              control: formularioPrecio.controls['fecha_vence']
            }"
          ></ng-container>
          <ng-container
            [ngTemplateOutlet]="formError"
            [ngTemplateOutletContext]="{
              validation: 'maxlength',
              message:
                'FORMULARIOS.VALIDACIONES.COMUNES.CAMPOMAXIMO' | translate,
              cantidadCaracteres: '100',
              control: formularioPrecio.controls['fecha_vence']
            }"
          ></ng-container>
          <ng-container
            [ngTemplateOutlet]="formError"
            [ngTemplateOutletContext]="{
              validation: 'pattern',
              message: 'FORMULARIOS.VALIDACIONES.COMUNES.NOVALIDO' | translate,
              control: formularioPrecio.controls['fecha_vence']
            }"
          ></ng-container>
        </div>
      </div>
      <div class="row mb-5">
        <div class="col-12">
          <ul
            ngbNav
            #nav="ngbNav"
            [(activeId)]="active"
            class="nav nav-tabs nav-line-tabs nav-line-tabs-2x mb-5 fs-6"
          >
            <li [ngbNavItem]="1" [destroyOnHide]="true" class="nav-item">
              <a
                class="nav-link"
                ngbNavLink
                data-bs-toggle="tab"
                translate="FORMULARIOS.TITULOS.FACTURACION.DETALLES"
              ></a>
              <ng-template ngbNavContent>
                <div class="table-responsive-sm">
                  <table
                    id="tableDetalles"
                    class="table table-row-dashed table-row-gray-500"
                  >
                    <thead>
                      <tr>
                        <th>Id</th>
                        <th
                          translate="FORMULARIOS.TITULOS.FACTURACION.PRODUCTO"
                        ></th>
                        <th
                          translate="FORMULARIOS.TITULOS.FACTURACION.PRECIO"
                        ></th>
                        <td></td>
                        <th class="text-center">
                          <button
                            (click)="agregarProductos()"
                            class="btn btn-sm btn-primary"
                            type="button"
                            translate="FORMULARIOS.TITULOS.FACTURACION.AGREGARITEM"
                          ></button>
                        </th>
                      </tr>
                    </thead>
                    <tbody formArrayName="detalles">
                      <ng-container
                        *ngFor="let detalle of detalles.controls; let i = index"
                        [formGroupName]="i"
                      >
                        <tr>
                          <td>{{ detalle.value.id }}</td>
                          <td>
                            <app-comun-productos
                              [itemNombre]="detalle.value.item_nombre"
                              (emitirArrItems)="
                                agregarItemSeleccionado($event, i)
                              "
                            ></app-comun-productos>
                          </td>
                          <td>
                            <input
                              type="text"
                              (blur)="agregarProductos()"
                              [value]="detalle.value.item_precio"
                              formControlName="cantidad"
                              class="form-control-sm"
                              rows="1"
                              spellcheck="true"
                              appSoloNumeros
                            />
                          </td>
                          <td class="text-center">
                            <i
                              class="bi bi-trash fs-2x align-self-center cursor-pointer user-select-none text-hover-danger"
                              (click)="eliminarProducto(i, detalle.value.id)"
                            ></i>
                          </td>
                        </tr>
                      </ng-container>
                    </tbody>
                  </table>
                </div>
              </ng-template>
            </li>
          </ul>
          <div [ngbNavOutlet]="nav" class="mt-2"></div>
        </div>
      </div>
    </section>
  </app-card>
</form>
<ng-template
  #formError
  let-control="control"
  let-message="message"
  let-validation="validation"
  let-cantidadCaracteres="cantidadCaracteres"
>
  <ng-container
    *ngIf="control.hasError(validation) && (control.dirty || control.touched)"
  >
    <div class="fv-plugins-message-container">
      <div class="fv-help-block">
        <span role="alert"> {{ message }} {{ cantidadCaracteres }} </span>
      </div>
    </div>
  </ng-container>
</ng-template>
