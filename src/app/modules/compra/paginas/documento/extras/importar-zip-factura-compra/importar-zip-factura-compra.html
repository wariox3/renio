<div class="modal-header">
  <h4 class="modal-title" id="modal-basic-title">Importar zip</h4>
  <button
    type="button"
    class="btn-close"
    aria-label="Close"
    (click)="cerrarModal()"
  ></button>
</div>
<div class="modal-body">
  <section class="multiStepForm h-100">
    <div
      class="d-flex justify-content-center align-items-start mb-4 stepper-container"
    >
      @for (paso of formularioPasos(); track paso.id; let i = $index) {
        <div class="text-center position-relative step-item mx-3">
          <!-- Círculo numerado -->
          <div
            class="circle d-flex align-items-center justify-content-center"
            [ngClass]="{
              'circle-active': i === pasoFormularioActual(),
              'circle-inactive': i !== pasoFormularioActual(),
            }"
          >
            {{ paso.id }}
          </div>

          <!-- Título y descripción -->
          <div class="mt-2 fw-semibold">{{ paso.titulo }}</div>
          <div class="text-muted small">{{ paso.descripcion }}</div>

          <!-- Conector -->
          @if (i < formularioPasos().length - 1) {
            <div class="connector"></div>
          }
        </div>
      }
    </div>
    @if (pasoFormularioActual() === 0) {
      <form action="" id="multiStepForm">
        <div class="custom-file-upload">
          @if (archivoNombre() === "") {
            <input
              type="file"
              id="myfile"
              #fileInput
              (change)="archivoSeleccionado($event)"
              [accept]="'.zip'"
            />
            <button
              type="button"
              class="btn btn-outline btn-outline-dashed btn-outline-dark btn-active-light-dark"
              (click)="fileInput.click()"
              style="width: 100%; height: 100%"
            >
              <i class="bi bi-cloud-upload fs-2x cursorPointer"></i>
              Seleccionar archivo
            </button>
          } @else {
            <div
              class="image-input image-input-outline rounded border d-flex shadow-sm p-4"
              data-kt-image-input="true"
            >
              <div class="d-flex justify-content-between w-100">
                <div class="d-flex">
                  <div class="d-flex align-items-start">
                    <i class="bi bi-file-earmark-excel fs-6x text-success"></i>
                  </div>
                  <div class="d-flex flex-column">
                    <span class="fs-3 fw-semibold">{{ archivoNombre() }}</span>
                    <span>{{ archivoPeso() }}</span>
                  </div>
                </div>
                <div class="">
                  <i
                    class="bi bi-x text-danger fs-2x cursorPointer"
                    (click)="removerArchivoSeleccionado()"
                  ></i>
                </div>
              </div>
            </div>
          }
        </div>
        <img src="" alt="" />
      </form>

      <div Class="d-flex mb-2 justify-content-end gap-2">
        @if (cargardoDocumento$ | async) {
          <button class="btn btn-sm btn-primary" type="button" disabled>
            <span
              class="spinner-border spinner-border-sm me-2"
              aria-hidden="true"
            ></span>
            <span role="status" translate="LISTAS.COMUNES.CARGANDO"></span>
          </button>
        } @else {
          <button
            translate="FORMULARIOS.BOTONES.COMUNES.IMPORTAR"
            type="submit"
            class="btn btn-sm btn-primary"
            [disabled]="archivoNombre() === ''"
            (click)="guardarArchivo()"
          ></button>
        }
      </div>
    }
    @if (pasoFormularioActual() === 1) {
      <div
        class="alert alert-danger d-flex align-items-center gap-2"
        role="alert"
        appAnimationFadeinLeft
      >
        <div>
          El contacto asociado a esta factura no existe. Debes crearlo antes de
          poder generar las facturas.
        </div>
      </div>
      <app-contacto-formulario-proveedor
        [ocultarBtnAtras]="true"
        [datosContacto]="this.datosFacturaContacto()"
        [tituloFijo]="true"
        [esProvedor]="true"
        [esCliente]="false"
        (emitirGuardoRegistro)="crearContacto($event)"
      ></app-contacto-formulario-proveedor>
    }
    @if (pasoFormularioActual() === 2) {
      <form [formGroup]="formularioFactura" (ngSubmit)="crearFactura()">
        <section appAnimationFadeinLeft>
          <div class="row mb-5">
            <div class="col-md-4 col-sm-12">
              <label
                class="form-label"
                translate="FORMULARIOS.CAMPOS.FACTURA.GRUPO"
              >
              </label>
              <app-seleccionar-grupo
                [grande]="true"
                [sugerirPrimerValor]="true"
                (selectChange)="onSeleccionarGrupoChange($event)"
                [valorInicial]="
                  formularioFactura.get('grupo_contabilidad')?.value
                "
              ></app-seleccionar-grupo>
            </div>
            <div class="col-md-4 col-sm-12">
              <label
                class="form-label"
                translate="FORMULARIOS.CAMPOS.FACTURA.FORMAPAGO"
              >
              </label>
              <ng-select
                [items]="formaPagoLista()"
                bindLabel="nombre"
                bindValue="id"
                formControlName="forma_pago"
                notFoundText="Sin elementos"
                placeholder="Selecciona un elemento"
                class="select2Custom"
              >
              </ng-select>
            </div>
            <div class="col-md-4 col-sm-12">
              <label
                class="form-label"
                translate="FORMULARIOS.CAMPOS.COMUNES.ALMACEN"
              ></label>
              <app-seleccionar-almacen
                [grande]="true"
                [isEdicion]="true"
                [sugerirPrimerValor]="true"
                [itemNombre]="formularioFactura.get('almacen_nombre')?.value"
                [estadoAprobado]="false"
                [campoInvalido]="
                  formularioFactura.get('almacen')?.touched &&
                  formularioFactura.get('almacen')?.hasError('required')
                "
                (emitirItemSeleccionado)="recibirAlmacenSeleccionado($event)"
                (emitirLineaVacia)="recibirAlmacenVacio()"
              ></app-seleccionar-almacen>
            </div>
          </div>
          <div Class="d-flex mb-2 justify-content-end gap-2">
            <button
              type="submit"
              class="btn btn-sm btn-primary"
              [disabled]="inhabilitarBtnCrearFactura()"
            >
              Crear factura
            </button>
          </div>
        </section>

        <div class="row" appAnimationFadeinLeft>
          <div class="table-responsive-sm">
            <table class="table table-bordered table-sm mb-2">
              <tbody>
                <tr>
                  <td
                    class="fw-bold text-gray-800 fs-6 bg-gray-100"
                    translate="FORMULARIOS.CAMPOS.COMUNES.CONTACTO"
                  ></td>
                  <td>{{ datosFactura()?.contacto?.nombre_corto }}</td>
                  <td
                    class="fw-bold text-gray-800 fs-6 bg-gray-100"
                    translate="FORMULARIOS.CAMPOS.COMUNES.NUMEROIDENTIFICACION"
                  ></td>
                  <td>{{ datosFactura()?.contacto?.numero_identificacion }}</td>
                </tr>
                <tr>
                  <td
                    class="fw-bold text-gray-800 fs-6 bg-gray-100"
                    translate="FORMULARIOS.CAMPOS.COMUNES.NUMERO"
                  ></td>
                  <td>{{ datosFactura()?.documento?.numero }}</td>
                  <td
                    class="fw-bold text-gray-800 fs-6 bg-gray-100"
                    translate="FORMULARIOS.CAMPOS.FACTURA.REFERENCIA_PREFIJO"
                  ></td>
                  <td>{{ datosFactura()?.documento?.prefijo }}</td>
                </tr>
                <tr>
                  <td
                    class="fw-bold text-gray-800 fs-6 bg-gray-100"
                    translate="FORMULARIOS.CAMPOS.FACTURA.FECHAFACTURA"
                  ></td>
                  <td>{{ datosFactura()?.documento?.fecha }}</td>
                  <td
                    class="fw-bold text-gray-800 fs-6 bg-gray-100"
                    translate="FORMULARIOS.CAMPOS.FACTURA.FECHAVENCIMIENTO"
                  ></td>
                  <td>{{ datosFactura()?.documento?.fecha_vence }}</td>
                </tr>
                <tr>
                  <td
                    class="fw-bold text-gray-800 fs-6 bg-gray-100"
                    translate="FORMULARIOS.CAMPOS.FACTURA.REFERENCIA_CUE"
                  ></td>
                  <td colspan="3">{{ datosFactura()?.documento?.cue }}</td>
                </tr>
                <tr>
                  <td
                    class="fw-bold text-gray-800 fs-6 bg-gray-100"
                    translate="FORMULARIOS.CAMPOS.FACTURA.COMENTARIO"
                  ></td>
                  <td colspan="3">
                    {{ datosFactura()?.documento?.comentario }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="table-responsive-sm">
            <table
              id="tableDetalles"
              class="table table-bordered table-row-gray-500"
            >
              <thead>
                <tr class="text-center">
                  <th class="bg-gray-100" style="width: 50px">Id</th>
                  <th
                    class="bg-gray-100"
                    translate="FORMULARIOS.TITULOS.FACTURACION.ITEM"
                  ></th>
                  <th
                    class="bg-gray-100"
                    translate="FORMULARIOS.TITULOS.FACTURACION.CANTIDAD"
                  ></th>
                  <th class="bg-gray-100">Precio unitario</th>
                  <th
                    class="bg-gray-100"
                    translate="FORMULARIOS.TITULOS.FACTURACION.TOTAL"
                  ></th>
                </tr>
              </thead>
              <tbody>
                @for (
                  detalle of datosFactura()?.documento?.detalles;
                  track detalle.item
                ) {
                  <tr>
                    <td style="width: 50px">{{ detalle.item }}</td>
                    <td class="w-50 text-start">
                      {{ detalle.item_nombre }}
                    </td>
                    <td class="text-end">
                      {{ detalle.cantidad | number }}
                    </td>
                    <td class="text-end">
                      {{ detalle.precio_unitario | number }}
                    </td>
                    <td class="text-end">
                      {{ detalle.valor_total | number }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </form>
    }
  </section>
</div>
