<!-- Sección de invitación mejorada -->
<div class="card mb-6 shadow-sm border-0">
  <div class="card-header border-0 py-4">
    <div class="d-flex align-items-center">
      <div class="symbol symbol-40px me-3">
        <div class="symbol-label bg-primary">
          <i class="bi bi-person-plus text-white fs-4"></i>
        </div>
      </div>
      <div>
        <h3 class="card-title mb-0 text-gray-800" translate="FORMULARIOS.TITULOS.CONTENEDOR.NUEVAINVITACION"></h3>
        <p class="text-muted mb-0 fs-7">Invita nuevos usuarios a colaborar en tu contenedor</p>
      </div>
    </div>
  </div>
  
  <div class="card-body p-6">
    <form
      class="form w-100"
      [formGroup]="formularioEmpresaInvitacion"
      (ngSubmit)="formSubmit()"
    >
      <div class="row align-items-end">
        <div class="col-md-8 col-sm-12 mb-3">
          <label
            translate="FORMULARIOS.CAMPOS.COMUNES.CORREO"
            class="form-label fw-semibold text-gray-700 fs-6 required"
          ></label>
          <div class="input-group">
            <span class="input-group-text bg-light border-end-0">
              <i class="bi bi-envelope text-muted"></i>
            </span>
            <input
              type="email"
              formControlName="nombre"
              [placeholder]="'Ingresa el correo electrónico del usuario'"
              class="form-control border-start-0 bg-transparent"
              [disabled]="contenedorAlcanzoMaxUsuarios()"
              [ngClass]="{
                'is-invalid':
                  formularioEmpresaInvitacion.controls['nombre'].touched &&
                  formularioEmpresaInvitacion.controls['nombre'].invalid,
                'is-valid':
                  formularioEmpresaInvitacion.controls['nombre'].touched &&
                  formularioEmpresaInvitacion.controls['nombre'].valid,
              }"
            />
          </div>
          
          <!-- Mensajes de validación -->
          <!-- <ng-container
            [ngTemplateOutlet]="formError"
            [ngTemplateOutletContext]="{
              validation: 'required',
              message: 'FORMULARIOS.VALIDACIONES.COMUNES.REQUERIDO' | translate,
              control: formularioEmpresaInvitacion.controls['nombre'],
            }"
          ></ng-container> -->
        </div>
        
        <div class="col-md-4 col-sm-12 mb-3">
          <button
            [disabled]="contenedorAlcanzoMaxUsuarios() || formularioEmpresaInvitacion.invalid"
            type="submit"
            class="btn btn-primary w-100 d-flex align-items-center justify-content-center"
            #btnGuardar
          >
            <i class="bi bi-send me-2"></i>
            <span translate="FORMULARIOS.BOTONES.CONTENEDOR.INVITAR"></span>
          </button>
        </div>
        <ng-container
            [ngTemplateOutlet]="formError"
            [ngTemplateOutletContext]="{
              validation: 'pattern',
              message: 'FORMULARIOS.VALIDACIONES.COMUNES.TIPOCORREO' | translate,
              control: formularioEmpresaInvitacion.controls['nombre'],
            }"
          ></ng-container>
      </div>

      <!-- Alerta de límite alcanzado -->
      @if (contenedorAlcanzoMaxUsuarios()) {
        <div class="alert alert-warning d-flex align-items-center mt-4" role="alert">
          <i class="bi bi-exclamation-triangle-fill text-warning me-3 fs-4"></i>
          <div>
            <strong>Límite alcanzado</strong><br>
            <small>Este contenedor ha alcanzado el límite de invitaciones. No es posible agregar más personas.</small>
          </div>
        </div>
      }
    </form>
  </div>
</div>
<!-- Sección de usuarios mejorada -->
<div class="card shadow-sm border-0">
  <div class="card-header border-0 py-4">
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <div class="symbol symbol-40px me-3">
          <div class="symbol-label bg-info">
            <i class="bi bi-people text-white fs-4"></i>
          </div>
        </div>
        <div>
          <h3 class="card-title mb-0 text-gray-800" translate="FORMULARIOS.TITULOS.COMUNES.USUARIOS"></h3>
          <p class="text-muted mb-0 fs-7">{{ invitaciones().length }} usuario(s) en el contenedor</p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="card-body p-0">
    @if (invitaciones().length === 0) {
      <!-- Estado vacío -->
      <div class="text-center py-10">
        <div class="symbol symbol-100px mx-auto mb-4">
          <div class="symbol-label bg-light-primary">
            <i class="bi bi-people text-primary fs-1"></i>
          </div>
        </div>
        <h4 class="text-gray-800 mb-2">No hay usuarios invitados</h4>
        <p class="text-muted fs-6">Comienza invitando usuarios para colaborar en tu contenedor</p>
      </div>
    } @else {
      <!-- Lista de usuarios -->
      <div class="table-responsive">
        <table class="table table-hover align-middle gs-0 gy-4">
          <thead class="bg-light">
            <tr class="fw-bold text-muted">
              <th class="ps-6 rounded-start">Usuario</th>
              <th>Rol</th>
              <th class="text-end pe-6 rounded-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let invitacion of invitaciones(); let i = index"
              appAnimationFadeinUp
              [animacionDelay]="i + 1"
              class="border-bottom border-gray-200"
            >
              <!-- Usuario -->
              <td class="ps-6">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px me-3">
                    <div class="symbol-label bg-light-success">
                      <i class="bi bi-person text-success fs-5"></i>
                    </div>
                  </div>
                  <div>
                    <div class="text-gray-800 fw-bold fs-6">{{ invitacion.usuario__username }}</div>
                    <div class="text-muted fs-7">{{ invitacion.usuerio__nombre || 'Usuario' }}</div>
                  </div>
                </div>
              </td>
              
              <!-- Rol -->
              <td>
                <span 
                  class="badge fs-7"
                  [ngClass]="{
                    'badge-light-success': invitacion.rol === 'propietario',
                    'badge-light-primary': invitacion.rol === 'administrador',
                    'badge-light-info': invitacion.rol === 'usuario'
                  }"
                >
                  <i 
                    class="me-1"
                    [ngClass]="{
                      'bi bi-crown': invitacion.rol === 'propietario',
                      'bi bi-shield-check': invitacion.rol === 'administrador',
                      'bi bi-person': invitacion.rol === 'usuario'
                    }"
                  ></i>
                  {{ invitacion.rol | titlecase }}
                </span>
              </td>
              
              <!-- Acciones -->
              <td class="text-end pe-6">
                @if (invitacion.rol !== 'propietario') {
                  <button
                    type="button"
                    class="btn btn-sm btn-light-danger btn-icon"
                    title="Eliminar usuario"
                    (click)="eliminarInvitado(invitacion.id)"
                  >
                    <i class="bi bi-trash fs-6"></i>
                  </button>
                } @else {
                  <span class="badge badge-light-warning fs-8">
                    <i class="bi bi-shield-lock me-1"></i>
                    Protegido
                  </span>
                }
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    }
  </div>
</div>
<ng-template
  #formError
  let-control="control"
  let-message="message"
  let-validation="validation"
  let-cantidadCaracteres="cantidadCaracteres"
>
  <ng-container
    *ngIf="control.hasError(validation) && (control.dirty || control.touched)"
  >
    <div class="fv-plugins-message-container">
      <div class="fv-help-block">
        <span role="alert"> {{ message }} {{ cantidadCaracteres }} </span>
      </div>
    </div>
  </ng-container>
</ng-template>
